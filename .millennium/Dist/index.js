const MILLENNIUM_IS_CLIENT_MODULE=!0,pluginName="steam-game-helper";function InitializePlugins(){var e,t;let a;(e=window.PLUGIN_LIST||(window.PLUGIN_LIST={}))[pluginName]||(e[pluginName]={}),(t=window.MILLENNIUM_PLUGIN_SETTINGS_STORE||(window.MILLENNIUM_PLUGIN_SETTINGS_STORE={}))[pluginName]||(t[pluginName]={}),window.MILLENNIUM_SIDEBAR_NAVIGATION_PANELS||(window.MILLENNIUM_SIDEBAR_NAVIGATION_PANELS={}),function(e){e[e.CallServerMethod=0]="CallServerMethod"}(a||(a={}));let n=window.MILLENNIUM_PLUGIN_SETTINGS_STORE[pluginName],i=`Millennium.Internal.IPC.[${pluginName}]`;const o={DropDown:["string","number","boolean"],NumberTextInput:["number"],StringTextInput:["string"],FloatTextInput:["number"],CheckBox:["boolean"],NumberSlider:["number"],FloatSlider:["number"]};function r(e,t,n){return MILLENNIUM_BACKEND_IPC.postMessage(a.CallServerMethod,{pluginName:e,methodName:"__builtins__.__update_settings_value__",argumentList:{name:t,value:n}})}n.ignoreProxyFlag=!1,async function(){for(;"undefined"==typeof MainWindowBrowserManager;)await new Promise(e=>setTimeout(e,0));MainWindowBrowserManager?.m_browser?.on("message",(e,t)=>{if(e!==i)return;const{name:a,value:o}=JSON.parse(t);n.ignoreProxyFlag=!0,n.settingsStore[a]=o,r(pluginName,a,o),n.ignoreProxyFlag=!1})}();const s=e=>new Proxy(e,{set(e,t,a){if(!(t in e))throw new TypeError(`Property ${String(t)} does not exist on plugin settings`);const s=o[e[t].type],l=e[t]?.range;if(s.includes("number")&&"number"==typeof a&&(l&&(a=function(e,t,a){return Math.max(t,Math.min(a,e))}(a,l[0],l[1])),a||(a=0)),!s.includes(typeof a))throw new TypeError(`Expected ${s.join(" or ")}, got ${typeof a}`);return e[t].value=a,((e,t)=>{n.ignoreProxyFlag||(r(pluginName,e,t),"undefined"!=typeof MainWindowBrowserManager&&MainWindowBrowserManager?.m_browser?.PostMessage(i,JSON.stringify({name:e,value:t})))})(String(t),a),!0},get:(e,t)=>"__raw_get_internals__"===t?e:t in e?e[t].value:void 0});n.DefinePluginSetting=s,n.settingsStore=s({})}InitializePlugins();const __call_server_method__=(e,t)=>Millennium.callServerMethod(pluginName,e,t),__wrapped_callable__=e=>MILLENNIUM_API.callable(__call_server_method__,e);let PluginEntryPointMain=function(){return function(e,t,a){"use strict";const n=__wrapped_callable__("Backend.get_review"),i=__wrapped_callable__("Backend.save_review"),o=__wrapped_callable__("Backend.delete_review"),r=__wrapped_callable__("Backend.debug_log"),s=[{value:"IN_PROGRESS",label:"В процессе"},{value:"FINISHED",label:"Пройдена"},{value:"SKIPPED",label:"Дропнута"}],l=({appId:e,onClose:l})=>{const[d,g]=a.useState(""),[p,u]=a.useState(0),[w,m]=a.useState("IN_PROGRESS"),[c,_]=a.useState(!0),[S,E]=a.useState(!1),[v,N]=a.useState(!1),[f,P]=a.useState(!1),[I,y]=a.useState(null);a.useEffect(()=>{(async()=>{try{const t=await n({app_id:e});await r({message:`Raw review data received: ${t}`});const a=JSON.parse(t);await r({message:`Parsed review data: ${JSON.stringify(a)}`}),y(a),a.review&&(g(a.review),await r({message:`Set review text: ${a.review}`})),a.rating&&(u(a.rating),await r({message:`Set rating: ${a.rating}`})),a.status&&(m(a.status),await r({message:`Set status: ${a.status}`}))}catch(e){await r({message:`Error loading review: ${e}`})}finally{_(!1)}})()},[e]);const b=e=>e<=2?"#dc3545":e<=3.5?"#ffc107":"#28a745",M=()=>!I||d!==(I.review||"")||p!==(I.rating||0)||w!==(I.status||"IN_PROGRESS");return a.useEffect(()=>{M()&&(N(!1),P(!1))},[d,p,w]),c?window.SP_REACT.createElement(t.ModalRoot,{closeModal:l},window.SP_REACT.createElement("div",null,"Loading...")):window.SP_REACT.createElement(t.ModalRoot,{closeModal:l},window.SP_REACT.createElement("div",{style:{padding:"20px",minWidth:"500px"}},window.SP_REACT.createElement("h2",{style:{marginBottom:"20px"}},"Game Review"),window.SP_REACT.createElement("div",{style:{marginBottom:"15px"}},window.SP_REACT.createElement("label",{style:{display:"block",marginBottom:"5px",fontWeight:"bold"}},"Review:"),window.SP_REACT.createElement("textarea",{value:d,onChange:e=>g(e.target.value),placeholder:"Write your game review...",style:{width:"100%",height:"120px",padding:"8px",border:"1px solid #ccc",borderRadius:"4px",resize:"vertical",fontFamily:"inherit"}})),window.SP_REACT.createElement("div",{style:{marginBottom:"15px"}},window.SP_REACT.createElement("label",{style:{display:"block",marginBottom:"5px",fontWeight:"bold"}},"Rating (1-5):"),window.SP_REACT.createElement("div",{style:{display:"flex",gap:"10px",alignItems:"center"}},window.SP_REACT.createElement("input",{type:"range",min:"1",max:"5",step:"0.5",value:p||1,onChange:e=>u(parseFloat(e.target.value)),style:{flex:1,height:"20px",background:`linear-gradient(to right, ${b(p||1)} 0%, ${b(p||1)} ${((p||1)-1)/4*100}%, #ddd ${((p||1)-1)/4*100}%, #ddd 100%)`,outline:"none",borderRadius:"10px",cursor:"pointer"}}),window.SP_REACT.createElement("span",{style:{minWidth:"60px",textAlign:"center",fontWeight:"bold",color:b(p||1)}},p>0?`${p}/5`:"1/5"))),window.SP_REACT.createElement("div",{style:{marginBottom:"20px"}},window.SP_REACT.createElement("label",{style:{display:"block",marginBottom:"5px",fontWeight:"bold"}},"Game Status:"),window.SP_REACT.createElement("select",{value:w,onChange:e=>m(e.target.value),style:{width:"100%",padding:"8px",border:"1px solid #ccc",borderRadius:"4px",fontSize:"14px"}},s.map(e=>window.SP_REACT.createElement("option",{key:e.value,value:e.value},e.label)))),window.SP_REACT.createElement("div",{style:{display:"flex",gap:"10px",justifyContent:"flex-end",alignItems:"center"}},window.SP_REACT.createElement(t.DialogButton,{onClick:async()=>{E(!0);try{const t={review:d,rating:p,status:w};await r({message:`Saving review data: ${JSON.stringify(t)}`}),await i({app_id:e,review_data:JSON.stringify(t)})?(await r({message:"Review saved successfully"}),N(!0),P(!1),y({review:d,rating:p,status:w})):await r({message:"Failed to save review"})}catch(e){await r({message:`Error saving review: ${e}`})}finally{E(!1)}},disabled:S||!M(),style:{backgroundColor:v?"#28a745":"#007bff",color:"white",border:"none",padding:"8px 16px",borderRadius:"4px",cursor:S||!M()?"not-allowed":"pointer",opacity:S||!M()?.6:1,display:"flex",alignItems:"center",gap:"5px"}},S?"Saving...":v?"✓ Saved":"Save"),window.SP_REACT.createElement("button",{onClick:async()=>{try{await o({app_id:e})&&(await r({message:"Review deleted successfully"}),P(!0),N(!1),g(""),u(0),m("IN_PROGRESS"),y({}))}catch(e){await r({message:`Error deleting review: ${e}`})}},style:{backgroundColor:f?"#28a745":"#dc3545",color:"white",border:"none",padding:"8px 12px",borderRadius:"4px",cursor:"pointer",fontSize:"14px",display:"flex",alignItems:"center",gap:"5px"},title:f?"Review deleted":"Delete review"},f?"🗑️✓":"🗑️"))))},d="SP Desktop_uid0";async function g(e){if(await r({message:`OnPopupCreation called with popup: ${e?.m_strName}`}),e.m_strName===d){await r({message:"Main popup detected, initializing..."});for(var a=void 0;!a;){await r({message:"Waiting for MainWindowBrowserManager"});try{a=MainWindowBrowserManager,await r({message:"MainWindowBrowserManager found"})}catch(e){await r({message:`MainWindowBrowserManager not ready yet: ${e}`}),await t.sleep(100)}}await r({message:"Setting up browser event listener"}),MainWindowBrowserManager.m_browser.on("finished-request",async(a,n)=>{const i=MainWindowBrowserManager.m_lastLocation.pathname;if(await r({message:`Browser navigation detected. Path: ${i}, URL: ${a}, Previous: ${n}`}),i.startsWith("/library/app/")){await r({message:"Game page detected, processing..."});const a=i.match(/\/library\/app\/(\d+)/);if(await r({message:`AppId match result: ${JSON.stringify(a)}`}),a){const n=parseInt(a[1]);await r({message:`Extracted appId: ${n}`});try{await r({message:"Looking for game settings button..."});const a=await(async(e,a=document)=>[...await t.Millennium.findElement(a,e)][0])(`div.${t.findModule(e=>e.InPage).InPage} div.${t.findModule(e=>e.AppButtonsContainer).AppButtonsContainer} > div.${t.findModule(e=>e.MenuButtonContainer).MenuButtonContainer}:not([role="button"])`,e.m_popup.document);if(await r({message:`Game settings button found: ${!!a}`}),a){await r({message:`Game settings button parent: ${!!a.parentNode}`});const i=a.parentNode.querySelector("div.steam-game-helper-review-button");if(await r({message:`Existing review button check: ${!!i}`}),i)await r({message:"Review button already exists, skipping creation"});else{await r({message:"Creating review button..."});const i=a.cloneNode(!0);await r({message:`Review button cloned: ${!!i}`}),i.classList.add("steam-game-helper-review-button"),i.firstChild&&(i.firstChild.innerHTML="📝"),i.title="Write Review",await r({message:"Review button configured, inserting..."}),a.parentNode.insertBefore(i,a.nextSibling),await r({message:"Review button inserted successfully"}),i.addEventListener("click",async()=>{await r({message:`Review button clicked for appId: ${n}`}),t.showModal(window.SP_REACT.createElement(l,{appId:n,onClose:()=>{}}),e.m_popup.window,{strTitle:"Game Review",bHideMainWindowForPopouts:!1,bForcePopOut:!0,popupHeight:600,popupWidth:600})}),await r({message:"Review button click handler added"})}}else await r({message:"Game settings button not found"})}catch(e){await r({message:`Error processing game page: ${e}`})}}else await r({message:"No appId found in path"})}else await r({message:"Not a game page, skipping"})}),await r({message:"Browser event listener setup complete"})}else await r({message:`Not main popup, ignoring: ${e?.m_strName}`})}return e.default=async function(){await r({message:"Frontend startup"}),await r({message:"Waiting for services to initialize..."}),await App.WaitForServicesInitialized(),await r({message:"Services initialized, checking for existing popup..."});const e=g_PopupManager.GetExistingPopup(d);await r({message:`Existing popup found: ${!!e}`}),e&&(await r({message:"Processing existing popup..."}),g(e)),await r({message:"Adding popup creation callback..."}),g_PopupManager.AddPopupCreatedCallback(g),await r({message:"Plugin initialization complete"})},Object.defineProperty(e,"__esModule",{value:!0}),e}({},window.MILLENNIUM_API,window.SP_REACT)};function ExecutePluginModule(){let e=window.MILLENNIUM_PLUGIN_SETTINGS_STORE[pluginName];e.OnPluginConfigChange=function(t,a,n){t in e.settingsStore&&(e.ignoreProxyFlag=!0,e.settingsStore[t]=n,e.ignoreProxyFlag=!1)},MILLENNIUM_BACKEND_IPC.postMessage(0,{pluginName:pluginName,methodName:"__builtins__.__millennium_plugin_settings_parser__"}).then(async t=>{"string"==typeof t.returnValue&&(e.ignoreProxyFlag=!0,e.settingsStore=e.DefinePluginSetting(Object.fromEntries(JSON.parse(atob(t.returnValue)).map(e=>[e.functionName,e]))),e.ignoreProxyFlag=!1);let a=PluginEntryPointMain();Object.assign(window.PLUGIN_LIST[pluginName],{...a,__millennium_internal_plugin_name_do_not_use_or_change__:pluginName});let n=await a.default();var i;n&&(i=n)&&void 0!==i.title&&void 0!==i.icon&&void 0!==i.content?(window.MILLENNIUM_SIDEBAR_NAVIGATION_PANELS[pluginName]=n,MILLENNIUM_BACKEND_IPC.postMessage(1,{pluginName:pluginName})):console.warn(`Plugin ${pluginName} does not contain proper SidebarNavigation props and therefor can't be mounted by Millennium. Please ensure it has a title, icon, and content.`)})}ExecutePluginModule();