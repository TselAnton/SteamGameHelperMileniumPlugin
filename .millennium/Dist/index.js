const MILLENNIUM_IS_CLIENT_MODULE=!0,pluginName="steam-game-helper";function InitializePlugins(){var e,t;let a;(e=window.PLUGIN_LIST||(window.PLUGIN_LIST={}))[pluginName]||(e[pluginName]={}),(t=window.MILLENNIUM_PLUGIN_SETTINGS_STORE||(window.MILLENNIUM_PLUGIN_SETTINGS_STORE={}))[pluginName]||(t[pluginName]={}),window.MILLENNIUM_SIDEBAR_NAVIGATION_PANELS||(window.MILLENNIUM_SIDEBAR_NAVIGATION_PANELS={}),function(e){e[e.CallServerMethod=0]="CallServerMethod"}(a||(a={}));let n=window.MILLENNIUM_PLUGIN_SETTINGS_STORE[pluginName],i=`Millennium.Internal.IPC.[${pluginName}]`;const o={DropDown:["string","number","boolean"],NumberTextInput:["number"],StringTextInput:["string"],FloatTextInput:["number"],CheckBox:["boolean"],NumberSlider:["number"],FloatSlider:["number"]};function r(e,t,n){return MILLENNIUM_BACKEND_IPC.postMessage(a.CallServerMethod,{pluginName:e,methodName:"__builtins__.__update_settings_value__",argumentList:{name:t,value:n}})}n.ignoreProxyFlag=!1,async function(){for(;"undefined"==typeof MainWindowBrowserManager;)await new Promise(e=>setTimeout(e,0));MainWindowBrowserManager?.m_browser?.on("message",(e,t)=>{if(e!==i)return;const{name:a,value:o}=JSON.parse(t);n.ignoreProxyFlag=!0,n.settingsStore[a]=o,r(pluginName,a,o),n.ignoreProxyFlag=!1})}();const l=e=>new Proxy(e,{set(e,t,a){if(!(t in e))throw new TypeError(`Property ${String(t)} does not exist on plugin settings`);const l=o[e[t].type],s=e[t]?.range;if(l.includes("number")&&"number"==typeof a&&(s&&(a=function(e,t,a){return Math.max(t,Math.min(a,e))}(a,s[0],s[1])),a||(a=0)),!l.includes(typeof a))throw new TypeError(`Expected ${l.join(" or ")}, got ${typeof a}`);return e[t].value=a,((e,t)=>{n.ignoreProxyFlag||(r(pluginName,e,t),"undefined"!=typeof MainWindowBrowserManager&&MainWindowBrowserManager?.m_browser?.PostMessage(i,JSON.stringify({name:e,value:t})))})(String(t),a),!0},get:(e,t)=>"__raw_get_internals__"===t?e:t in e?e[t].value:void 0});n.DefinePluginSetting=l,n.settingsStore=l({})}InitializePlugins();const __call_server_method__=(e,t)=>Millennium.callServerMethod(pluginName,e,t),__wrapped_callable__=e=>MILLENNIUM_API.callable(__call_server_method__,e);let PluginEntryPointMain=function(){return function(e,t,a,n){"use strict";const i=__wrapped_callable__("Backend.get_review"),o=__wrapped_callable__("Backend.save_review"),r=__wrapped_callable__("Backend.delete_review"),l=__wrapped_callable__("Backend.debug_log"),s=__wrapped_callable__("Backend.get_game_image_base64"),d=async(e,a=document)=>[...await t.Millennium.findElement(a,e)][0],g=[{value:"IN_PROGRESS",label:"В процессе"},{value:"FINISHED",label:"Пройдена"},{value:"SKIPPED",label:"Пропущена"}],p=({games:e,onClose:a})=>{const[i,o]=n.useState(!1),[r,d]=n.useState(null),[g,p]=n.useState(0),[c,m]=n.useState(!1),[u,w]=n.useState(null),[_,f]=n.useState(!0);n.useEffect(()=>{_&&e.length>0&&0===e.filter(e=>e.installed).length&&(f(!1),alert("No installed games found in this collection. Showing all games instead."))},[_,e]);const h=_?e.filter(e=>e.installed):e,E=360/h.length;return window.SP_REACT.createElement(t.ModalRoot,{closeModal:a},window.SP_REACT.createElement("div",{style:{padding:"20px",minWidth:"800px",minHeight:"600px",display:"flex",flexDirection:"column",alignItems:"center"}},window.SP_REACT.createElement("h2",{style:{marginBottom:"20px"}},"Fortune Wheel - Choose Your Game!"),window.SP_REACT.createElement("div",{style:{display:"flex",width:"100%",justifyContent:"space-between",alignItems:"center"}},window.SP_REACT.createElement("div",{style:{width:"60%",display:"flex",justifyContent:"center",alignItems:"center",position:"relative"}},window.SP_REACT.createElement("div",{style:{width:"400px",height:"400px",borderRadius:"50%",border:"8px solid #333",position:"relative",overflow:"hidden",transform:`rotate(${g}deg)`,transition:i?"transform 10000ms cubic-bezier(0.25, 0.46, 0.45, 0.94)":"none",background:"conic-gradient("+h.map((e,t)=>`hsl(${360*t/h.length}, 63%, 52%) ${t*E}deg ${(t+1)*E}deg`).join(", ")+")"}},h.map((e,t)=>{const a=t*E+E/2,n=a*Math.PI/180,i=200+130*Math.cos(n),o=200+130*Math.sin(n),r=a>90&&a<270;return window.SP_REACT.createElement("div",{key:e.appid,style:{position:"absolute",left:`${i}px`,top:`${o}px`,transform:`translate(-50%, -50%) rotate(${r?a+180:a}deg)`,transformOrigin:"center",display:"flex",alignItems:"center",justifyContent:"center"}},window.SP_REACT.createElement("span",{style:{fontSize:"11px",fontWeight:"bold",color:"white",textShadow:"1px 1px 2px rgba(0,0,0,0.8)",maxWidth:"80px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",textAlign:"center"}},e.display_name))})),window.SP_REACT.createElement("div",{style:{position:"absolute",top:"-10px",left:"50%",transform:"translateX(-50%)",width:"0",height:"0",borderTop:"25px solid rgb(243, 179, 105)",borderLeft:"15px solid transparent",borderRight:"15px solid transparent",zIndex:100}})),window.SP_REACT.createElement("div",{style:{width:"35%",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",minHeight:"300px"}},c&&r?window.SP_REACT.createElement("div",{style:{textAlign:"center"}},window.SP_REACT.createElement("h3",{style:{marginBottom:"5px",color:"#28a745"}},"Selected Game!"),u?window.SP_REACT.createElement("img",{src:u,alt:r.display_name,style:{width:"200px",height:"300px",objectFit:"cover",borderRadius:"8px",marginBottom:"10px"}}):window.SP_REACT.createElement("div",{style:{width:"200px",height:"300px",backgroundColor:"#333",borderRadius:"8px",marginBottom:"10px",display:"flex",alignItems:"center",justifyContent:"center",color:"#666",fontSize:"12px"}},"No Image"),window.SP_REACT.createElement("h4",{style:{marginBottom:"20px"}},r.display_name)):window.SP_REACT.createElement("div",{style:{textAlign:"center",color:"#666"}},window.SP_REACT.createElement("h3",null,"Ready to spin?"),window.SP_REACT.createElement("p",null,"Click the Spin button to choose a random game from your collection!")))),window.SP_REACT.createElement("div",{style:{display:"flex",alignItems:"center",gap:"10px",marginTop:"15px",justifyContent:"center"}},window.SP_REACT.createElement("label",{style:{fontSize:"14px",fontWeight:"bold"}},"Installed games only:"),window.SP_REACT.createElement("input",{type:"checkbox",defaultChecked:!0,checked:_,onChange:e=>f(e.target.checked),style:{width:"18px",height:"18px",cursor:"pointer"}}),` (Total: ${_?h.length:e.length})`),window.SP_REACT.createElement("div",{style:{display:"flex",gap:"15px",marginTop:"20px",justifyContent:"center"}},window.SP_REACT.createElement(t.DialogButton,{onClick:()=>{if(i||0===h.length)return void(0===h.length&&_&&alert("No installed games found in this collection. Please uncheck 'Show only installed games' to see all games."));o(!0),m(!1),d(null),w(null);const e=8*Math.random()+15,t=g+360*e;p(t);const a=(270-t%360+360)%360,n=Math.floor(a/E)%h.length,r=h[n];setTimeout(async()=>{if(d(r),m(!0),o(!1),r.header_filename){await l({message:`Loading image for game: ${r.display_name}, appId: ${r.appid}, filename: ${r.header_filename}`});const e=await(async(e,t)=>{try{const a=await s({app_id:e.toString(),file_name:t});return await l({message:`Image base64 for app ${e}, file ${t}: ${a?"received":"null"}`}),a}catch(t){return await l({message:`Error getting image base64 for app ${e}: ${t}`}),null}})(r.appid,r.header_filename);await l({message:`>> Final image url: ${e}`}),w(e)}else await l({message:`No header_filename for game: ${r.display_name}`}),w(null)},1e4)},disabled:i||0===h.length,style:{backgroundColor:i?"#6c757d":0===h.length?"#dc3545":"#007bff",color:"white",border:"none",padding:"10px 20px",borderRadius:"4px",cursor:i||0===h.length?"not-allowed":"pointer",opacity:i||0===h.length?.6:1,fontSize:"16px",fontWeight:"bold"}},i?"Spinning...":0===h.length?"No Games Available":"Spin"),c&&r&&window.SP_REACT.createElement(t.DialogButton,{onClick:()=>{r&&(SteamUIStore.Navigate(`/library/app/${r.appid}`),a())},style:{backgroundColor:"#28a745",color:"white",border:"none",padding:"10px 20px",borderRadius:"4px",cursor:"pointer",fontSize:"16px",fontWeight:"bold"}},"View Game"))))},c=({appId:e,onClose:a})=>{const[s,d]=n.useState(""),[p,c]=n.useState(0),[m,u]=n.useState("IN_PROGRESS"),[w,_]=n.useState(""),[f,h]=n.useState(""),[E,S]=n.useState(!0),[y,x]=n.useState(!1),[b,v]=n.useState(!1),[C,P]=n.useState(!1),[N,I]=n.useState(null);n.useEffect(()=>{(async()=>{try{const t=await i({app_id:e});await l({message:`Raw review data received: ${t}`});const a=JSON.parse(t);if(await l({message:`Parsed review data: ${JSON.stringify(a)}`}),I(a),a.review){const e=(e=>{try{return"string"!=typeof e?e:e.includes("\\u")?e.replace(/\\u[\dA-F]{4}/gi,e=>String.fromCharCode(parseInt(e.replace(/\\u/g,""),16))):e}catch(t){return console.error("Error decoding UTF-8 string:",t),e}})(a.review),t=(e=>{try{if("string"!=typeof e)return e;const t=new TextEncoder,a=new TextDecoder("utf-8"),n=t.encode(e);return a.decode(n)}catch(t){return console.error("Error forcing UTF-8 encoding:",t),e}})((e=>{try{if("string"!=typeof e)return e;if(e.includes("Ð")||e.includes("Ñ")||e.includes("Ð°")||e.includes("Ð¸")){const t=new Uint8Array(e.length);for(let a=0;a<e.length;a++)t[a]=255&e.charCodeAt(a);const a=new TextDecoder("utf-8").decode(t),n=/[а-яё]/i;if(n.test(a)&&!n.test(e))return a}return e}catch(t){return console.error("Error fixing corrupted encoding:",t),e}})(e));await l({message:`Original review text: ${a.review}`}),await l({message:`After forceUtf8Encoding: ${t}`}),d(t),await l({message:`Final review text set: ${t}`})}a.rating&&(c(a.rating),await l({message:`Set rating: ${a.rating}`})),a.status&&(u(a.status),await l({message:`Set status: ${a.status}`})),a.created_at_formatted&&(h(a.created_at_formatted),await l({message:`Set created date: ${a.created_at_formatted}`})),a.finished_at_formatted&&(_(a.finished_at_formatted),await l({message:`Set finished date: ${a.finished_at_formatted}`}))}catch(e){await l({message:`Error loading review: ${e}`})}finally{S(!1)}})()},[e]);const R=()=>!N||s!==(N.review||"")||p!==(N.rating||0)||m!==(N.status||"IN_PROGRESS")||w!==(N.finished_at_formatted||"");return n.useEffect(()=>{R()&&(v(!1),P(!1))},[s,p,m,w]),E?window.SP_REACT.createElement(t.ModalRoot,{closeModal:a},window.SP_REACT.createElement("div",null,"Loading...")):window.SP_REACT.createElement(t.ModalRoot,{closeModal:a},window.SP_REACT.createElement("div",{style:{padding:"10px",minWidth:"500px"}},window.SP_REACT.createElement("h2",{style:{marginBottom:"20px"}},"Game Review"),window.SP_REACT.createElement("div",{style:{marginBottom:"15px"}},window.SP_REACT.createElement("label",{style:{display:"block",marginBottom:"5px",fontWeight:"bold"}},"Review:"),window.SP_REACT.createElement("textarea",{value:s,onChange:e=>d(e.target.value),placeholder:"Write your game review...",style:{width:"95%",height:"120px",padding:"8px",border:"1px solid #ccc",borderRadius:"4px",resize:"vertical",fontFamily:"inherit"}})),window.SP_REACT.createElement("div",{style:{marginBottom:"15px"}},window.SP_REACT.createElement("label",{style:{display:"block",marginBottom:"5px",fontWeight:"bold"}},"Rating (1-5):"),window.SP_REACT.createElement("div",{style:{display:"flex",gap:"10px",alignItems:"center"}},window.SP_REACT.createElement("input",{type:"range",min:"1",max:"5",step:"0.1",value:p||1,onChange:e=>c(parseFloat(e.target.value)),style:{flex:1,height:"20px",background:"background: linear-gradient(15deg, red, green)",outline:"none",borderRadius:"10px",cursor:"pointer"}}),window.SP_REACT.createElement("span",{style:{minWidth:"60px",textAlign:"center",fontWeight:"bold",color:(e=>e<=2?"#dc3545":e<=3.5?"#ffc107":e<=4.5?"#10A532":"#5281E6")(p||1)}},p>0?`${p}/5`:"1/5"))),window.SP_REACT.createElement("div",{style:{marginBottom:"15px"}},window.SP_REACT.createElement("label",{style:{display:"block",marginBottom:"5px",fontWeight:"bold"}},"Game Status:"),window.SP_REACT.createElement("select",{value:m,onChange:e=>u(e.target.value),style:{width:"97%",padding:"8px",border:"1px solid #ccc",borderRadius:"4px",fontSize:"14px"}},g.map(e=>window.SP_REACT.createElement("option",{key:e.value,value:e.value},e.label)))),"FINISHED"===m&&window.SP_REACT.createElement("div",{style:{marginBottom:"15px"}},window.SP_REACT.createElement("label",{style:{display:"block",marginBottom:"5px",fontWeight:"bold"}},"Finished Date:"),window.SP_REACT.createElement("input",{type:"date",value:w,onChange:e=>_(e.target.value),style:{width:"95%",padding:"8px",border:"1px solid #ccc",borderRadius:"4px",fontSize:"14px"}})),window.SP_REACT.createElement("div",{style:{display:"flex",gap:"10px",justifyContent:"flex-end",alignItems:"center"}},window.SP_REACT.createElement(t.DialogButton,{onClick:async()=>{x(!0);try{const t={review:s,rating:p,status:m};"FINISHED"===m&&w&&(t.finished_at_formatted=w,await l({message:`Adding finished date: ${w}`})),await l({message:`Saving review data: ${JSON.stringify(t)}`}),await o({app_id:e,review_data:JSON.stringify(t)})?(await l({message:"Review saved successfully"}),v(!0),P(!1),I({review:s,rating:p,status:m})):await l({message:"Failed to save review"})}catch(e){await l({message:`Error saving review: ${e}`})}finally{x(!1)}},disabled:y||!R(),style:{backgroundColor:b?"#28a745":"#007bff",color:"white",border:"none",padding:"8px 12px",borderRadius:"4px",cursor:y||!R()?"not-allowed":"pointer",opacity:y||!R()?.6:1,display:"flex",alignItems:"center",justifyContent:"center",width:"85%",height:"30px",fontSize:"14px",gap:"5px"}},y?"Saving...":b?"Saved ✓":"Save"),window.SP_REACT.createElement("button",{onClick:async()=>{try{await r({app_id:e})&&(await l({message:"Review deleted successfully"}),P(!0),v(!1),d(""),c(0),u("IN_PROGRESS"),_(""),h(""),I({}))}catch(e){await l({message:`Error deleting review: ${e}`})}},style:{backgroundColor:C?"#28a745":"#dc3545",color:"white",border:"none",padding:"8px 12px",borderRadius:"4px",fontSize:"14px",width:"15%",height:"45px",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",gap:"5px"},title:C?"Review deleted":"Delete review"},C?"🗑️✓":"🗑️"))))},m="SP Desktop_uid0";async function u(e){if(await l({message:`OnPopupCreation called with popup: ${e?.m_strName}`}),e.m_strName===m){await l({message:"Main popup detected, initializing..."});for(var n=void 0;!n;){await l({message:"Waiting for MainWindowBrowserManager"});try{n=MainWindowBrowserManager,await l({message:"MainWindowBrowserManager found"})}catch(e){await l({message:`MainWindowBrowserManager not ready yet: ${e}`}),await t.sleep(100)}}await l({message:"Setting up browser event listener"}),MainWindowBrowserManager.m_browser.on("finished-request",async(n,i)=>{const o=MainWindowBrowserManager.m_lastLocation.pathname;if(await l({message:`Browser navigation detected. Path: ${o}, Previous: ${i}`}),o.startsWith("/library/app/")){await l({message:"Game page detected, processing..."});const a=o.match(/\/library\/app\/(\d+)/);if(await l({message:`AppId match result: ${JSON.stringify(a)}`}),a){const n=parseInt(a[1]);await l({message:`Extracted appId: ${n}`});try{await l({message:"Looking for game settings button..."});const a=await d(`div.${t.findModule(e=>e.InPage).InPage} div.${t.findModule(e=>e.AppButtonsContainer).AppButtonsContainer} > div.${t.findModule(e=>e.MenuButtonContainer).MenuButtonContainer}:not([role="button"])`,e.m_popup.document);if(await l({message:`Game settings button found: ${!!a}`}),a){await l({message:`Game settings button parent: ${!!a.parentNode}`});const i=a.parentNode.querySelector("div.steam-game-helper-review-button");if(await l({message:`Existing review button check: ${!!i}`}),i)await l({message:"Review button already exists, skipping creation"});else{await l({message:"Creating review button..."});const i=a.cloneNode(!0);await l({message:`Review button cloned: ${!!i}`}),i.classList.add("steam-game-helper-review-button"),i.firstChild&&(i.firstChild.innerHTML="📝"),i.title="Write Review",await l({message:"Review button configured, inserting..."}),a.parentNode.insertBefore(i,a.nextSibling),await l({message:"Review button inserted successfully"}),i.addEventListener("click",async()=>{await l({message:`Review button clicked for appId: ${n}`}),t.showModal(window.SP_REACT.createElement(c,{appId:n,onClose:()=>{}}),e.m_popup.window,{strTitle:"Game Review",bHideMainWindowForPopouts:!1,bForcePopOut:!0,popupHeight:620,popupWidth:600})}),await l({message:"Review button click handler added"})}}else await l({message:"Game settings button not found"})}catch(e){await l({message:`Error processing game page: ${e}`})}}else await l({message:"No appId found in path"})}else if(o.startsWith("/library/collection/")){const n=uiStore.currentGameListSelection.strCollectionId;await l({message:`Found collectionId: ${n}`});try{await l({message:"Looking for collection options button..."});const i=await d(`div.${t.findModule(e=>e.CollectionOptions).CollectionOptions}`,e.m_popup.document);if(await l({message:`Collection options button found: ${!!i}`}),i){const o=i.querySelector("button.steam-game-helper-wheel-button");o&&(await l({message:"Removing existing fortune wheel button"}),o.parentNode?.removeChild(o)),await l({message:`Creating fortune wheel button for collection: ${n}`});const r=e.m_popup.document.createElement("div");a.render(window.SP_REACT.createElement(t.DialogButton,{className:"steam-game-helper-wheel-button",style:{width:"40px",marginLeft:"3px",marginRight:"3px",color:"white",border:"none",borderRadius:"4px",cursor:"pointer",fontSize:"12px",fontWeight:"bold"}},"🎯"),r),i.insertBefore(r,i.firstChild.nextSibling),await l({message:"Fortune wheel button inserted successfully"}),r.addEventListener("click",async()=>{await l({message:`Fortune wheel button clicked for collection: ${n}`});try{const a=collectionStore.GetCollection(n.replace("%20"," "));if(await l({message:`Collection found: ${!!a}`}),await l({message:`Games found: ${JSON.stringify(a.allApps)}`}),a&&a.allApps){const i=a.allApps[0];i&&(await l({message:`Sample app properties: ${Object.keys(i).join(", ")}`}),void 0!==i.installed&&await l({message:`Sample app installed status: ${i.installed}`}),i.per_client_data&&await l({message:`Sample app per_client_data: ${JSON.stringify(i.per_client_data)}`}));const o=a.allApps.map(e=>({appid:e.appid,display_name:e.display_name,header_filename:e.library_capsule_filename,installed:e.installed||e.per_client_data&&e.per_client_data.installed}));await l({message:`Found ${o.length} games in collection ${n}`}),o.length>0?(0===o.filter(e=>e.installed).length&&await l({message:"No installed games found in collection, showing all games by default"}),t.showModal(window.SP_REACT.createElement(p,{key:`fortune-wheel-${n}-${Date.now()}`,games:o,onClose:()=>{}}),e.m_popup.window,{strTitle:`Fortune Wheel - ${n}`,bHideMainWindowForPopouts:!1,bForcePopOut:!0,popupHeight:734,popupWidth:990})):await l({message:"Collection is empty, cannot show fortune wheel"})}else await l({message:"Collection not found or has no games"})}catch(e){await l({message:`Error getting collection games: ${e}`})}}),await l({message:"Fortune wheel button click handler added"})}else await l({message:"Collection options button not found"})}catch(e){await l({message:`Error processing collection page: ${e}`})}}else await l({message:"Not a game or collection page, skipping"})}),await l({message:"Browser event listener setup complete"})}else await l({message:`Not main popup, ignoring: ${e?.m_strName}`})}return e.default=async function(){await l({message:"Frontend startup"}),await l({message:"Waiting for services to initialize..."}),await App.WaitForServicesInitialized(),await l({message:"Services initialized, checking for existing popup..."});const e=g_PopupManager.GetExistingPopup(m);await l({message:`Existing popup found: ${!!e}`}),e&&(await l({message:"Processing existing popup..."}),u(e)),await l({message:"Adding popup creation callback..."}),g_PopupManager.AddPopupCreatedCallback(u),await l({message:"Plugin initialization complete"})},Object.defineProperty(e,"__esModule",{value:!0}),e}({},window.MILLENNIUM_API,window.SP_REACTDOM,window.SP_REACT)};function ExecutePluginModule(){let e=window.MILLENNIUM_PLUGIN_SETTINGS_STORE[pluginName];e.OnPluginConfigChange=function(t,a,n){t in e.settingsStore&&(e.ignoreProxyFlag=!0,e.settingsStore[t]=n,e.ignoreProxyFlag=!1)},MILLENNIUM_BACKEND_IPC.postMessage(0,{pluginName:pluginName,methodName:"__builtins__.__millennium_plugin_settings_parser__"}).then(async t=>{"string"==typeof t.returnValue&&(e.ignoreProxyFlag=!0,e.settingsStore=e.DefinePluginSetting(Object.fromEntries(JSON.parse(atob(t.returnValue)).map(e=>[e.functionName,e]))),e.ignoreProxyFlag=!1);let a=PluginEntryPointMain();Object.assign(window.PLUGIN_LIST[pluginName],{...a,__millennium_internal_plugin_name_do_not_use_or_change__:pluginName});let n=await a.default();var i;n&&(i=n)&&void 0!==i.title&&void 0!==i.icon&&void 0!==i.content?(window.MILLENNIUM_SIDEBAR_NAVIGATION_PANELS[pluginName]=n,MILLENNIUM_BACKEND_IPC.postMessage(1,{pluginName:pluginName})):console.warn(`Plugin ${pluginName} does not contain proper SidebarNavigation props and therefor can't be mounted by Millennium. Please ensure it has a title, icon, and content.`)})}ExecutePluginModule();